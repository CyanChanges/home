const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./ng92lm0S.js","./CizUMjxh.js","./YdqC_Kqx.js","./SO8p1qhc.js","./C6w0QBRd.js","./C2W49t-Q.js","./Cix6dcvq.js","./entry.DbMciFUA.css"])))=>i.map(i=>d[i]);
import{_ as f}from"./CizUMjxh.js";import{c as d,a as p,t as l}from"./B3jcX63a.js";import"./YdqC_Kqx.js";import"./SO8p1qhc.js";import"./C6w0QBRd.js";import"./C2W49t-Q.js";import"./Cix6dcvq.js";async function w(t,e){return await $fetch(`/api/content/${e}/database.sql`,{context:{},responseType:"text",headers:{"content-type":"text/plain"},query:{v:d[String(e)],t:void 0}})}async function g(t,e="gzip"){var s;const n=Uint8Array.from(atob(t),a=>a.charCodeAt(0)),o=(s=new Response(new Blob([n])).body)==null?void 0:s.pipeThrough(new DecompressionStream(e));return(await new Response(o).text()).split(`
`)}function m(t,e){const n=h(t),r={...e};for(const o in r)n[o]==="json"&&r[o]&&r[o]!=="undefined"&&(r[o]=JSON.parse(r[o])),n[o]==="boolean"&&r[o]!=="undefined"&&(r[o]=!!r[o]);for(const o in r)r[o]==="NULL"&&(r[o]=void 0);return r}function h(t){const e=t.match(/FROM\s+(\w+)/);if(!e)return{};const n=p[b(e[1])];return(n==null?void 0:n.fields)||{}}function b(t){return t.replace(/^_content_/,"")}let i;function I(t){return{all:async(e,n)=>(await u(t),i.exec({sql:e,bind:n,rowMode:"object",returnValue:"resultRows"}).map(r=>m(e,r))),first:async(e,n)=>(await u(t),m(e,i.exec({sql:e,bind:n,rowMode:"object",returnValue:"resultRows"}).shift())),exec:async(e,n)=>{await u(t),await i.exec({sql:e,bind:n})}}}async function u(t){if(!i){const c=await f(()=>import("./ng92lm0S.js"),__vite__mapDeps([0,1,2,3,4,5,6,7]),import.meta.url).then(a=>a.default);globalThis.sqlite3ApiConfig={silent:!0,debug:(...a)=>console.debug(...a),warn:(...a)=>{String(a[0]).includes("OPFS sqlite3_vfs")||console.warn(...a)},error:(...a)=>console.error(...a),log:(...a)=>console.log(...a)};const s=await c();i=new s.oo1.DB}if(window.sessionStorage.getItem("previewToken"))return i;let e=null;const n=`checksum_${t}`,r=`collection_${t}`;let o="matched";try{const c=i.exec({sql:`SELECT * FROM ${l.info} where id = '${n}'`,rowMode:"object",returnValue:"resultRows"}).shift();(c==null?void 0:c.version)!==d[String(t)]&&(o="mismatch")}catch{o="missing"}if(o!=="matched"){if(window.localStorage.getItem(`content_${n}`)===d[String(t)]&&(e=window.localStorage.getItem(`content_${r}`)),!e){e=await w(void 0,String(t));try{window.localStorage.setItem(`content_${n}`,d[String(t)]),window.localStorage.setItem(`content_${r}`,e)}catch(s){console.error("Database integrity check failed, rebuilding database",s)}}const c=await g(e);await i.exec({sql:`DROP TABLE IF EXISTS ${l[String(t)]}`}),o==="mismatch"&&await i.exec({sql:`DELETE FROM ${l.info} WHERE id = '${n}'`});for(const s of c)try{await i.exec(s)}catch(a){console.error("Error executing command",a)}}return i}export{I as loadDatabaseAdapter};
